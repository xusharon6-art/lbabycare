<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å©´å¹¼å„¿å‘å±•è¿½è¸ªä¸å®¶åº­æŒ‡å¯¼ç³»ç»Ÿ</title>
<style>
:root{
  --bg:#ffffff; --fg:#1f2937; --muted:#6b7280; --card:#f8fafc; --accent:#2563eb; --line:#e5e7eb;
  --good:#16a34a; --warn:#f59e0b; --bad:#ef4444; --chip:#e5e7eb; --chip-active:#dbeafe;
  --danger:#dc2626; --danger-bg:#fef2f2; --danger-line:#fecaca;
}
:root[data-theme="dark"]{
  --bg:#0b1220; --fg:#e5e7eb; --muted:#9ca3af; --card:#141b2e; --accent:#60a5fa; --line:#1f2937;
  --good:#22c55e; --warn:#fbbf24; --bad:#f87171; --chip:#1f2937; --chip-active:#0b3569;
  --danger-bg:#2a0d12; --danger-line:#7f1d1d;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Noto Sans SC","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;line-height:1.5}
.container{max-width:1200px;margin:0 auto;padding:16px}
.toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--bg);padding:8px 0;z-index:10}
.btn{appearance:none;border:1px solid var(--line);background:var(--card);color:var(--fg);padding:8px 12px;border-radius:999px;cursor:pointer}
.btn:hover{border-color:var(--accent)}
.select,.input{border:1px solid var(--line);padding:8px 12px;border-radius:10px;background:var(--bg);color:var(--fg)}
.input.num{width:68px;text-align:center}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
.tab{padding:10px 14px;border-radius:999px;border:1px solid var(--line);cursor:pointer;background:var(--chip);color:var(--fg)}
.tab.active{background:var(--chip-active);border-color:var(--accent)}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px}
@media (max-width:1000px){.grid-4{grid-template-columns:1fr 1fr}.grid-3,.grid-2{grid-template-columns:1fr}}
h1{font-size:22px;margin:6px 0 2px}
h2{font-size:18px;margin:10px 0 6px}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th,.table td{border-top:1px solid var(--line);padding:8px;vertical-align:top}
.table th{font-weight:600;text-align:left;color:var(--muted)}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{border:1px solid var(--line);background:var(--chip);padding:8px 12px;border-radius:999px;cursor:pointer}
.chip.active{background:var(--chip-active);border-color:var(--accent)}
.muted{color:var(--muted)}
.small{font-size:12px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
.badge.good{color:var(--good);border-color:var(--good)}
.badge.warn{color:var(--warn);border-color:var(--warn)}
.badge.bad{color:var(--bad);border-color:var(--bad)}
.chart-wrap{height:320px}
.small-chart{height:220px}
svg{width:100%;height:100%}
.footer{margin:20px 0 40px;color:var(--muted);text-align:center}
/* é¦–é¡µå¡ç‰‡ */
.home-cards{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width:900px){.home-cards{grid-template-columns:1fr}}
.home-card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:8px}
.home-card h3{margin:0}
/* æ€¥æ•‘æŒ‡å— & å…±é¤æŒ‡å¯¼ */
.guide-steps{counter-reset:step; list-style:none; padding-left:0; margin:8px 0 0}
.guide-steps li{position:relative; padding-left:44px; margin:10px 0}
.guide-steps li:before{
  counter-increment:step; content:counter(step);
  position:absolute; left:0; top:2px; width:28px; height:28px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  border:2px solid var(--accent); color:var(--accent); font-weight:700
}
.guide-bullets{margin:8px 0 0; padding-left:18px}
.alert-bar{margin-top:16px; padding:14px 16px; border:1px solid var(--danger-line); background:var(--danger-bg); color:var(--danger); border-radius:12px}
/* å…±é¤äº’åŠ¨ */
.feed-row{display:flex;align-items:center;gap:12px;margin-top:8px}
.feed-svg{width:100px;height:100px;flex-shrink:0}
.feed-card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:10px}
.feed-tip{margin-top:6px;font-size:13px;color:var(--muted)}
.toggle-btn{cursor:pointer;border:none;background:var(--accent);color:#fff;padding:6px 10px;border-radius:8px;font-size:13px}
/* è¡¨æƒ…è´´çº¸åŒº */
.stickers{display:flex;gap:12px;margin-top:8px}
.sticker{font-size:42px;line-height:1;cursor:pointer;border:1px solid var(--line);border-radius:12px;padding:10px 14px;background:#fff0}
.sticker.active{border-color:var(--accent);box-shadow:0 0 0 2px var(--chip-active) inset}
/* æ‰“å°ä¼˜åŒ– */
@media print{
  .toolbar,.tabs,#home{display:none !important}
  .card{border:none;break-inside:avoid}
}
</style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="themeBtn">ğŸŒ— ä¸»é¢˜</button>
        <button class="btn" id="printBtn">ğŸ–¨ æ‰“å°/å¯¼å‡ºPDF</button>
        <button class="btn" id="resetBtn">ğŸ—‘ é‡ç½®</button>
      
<button class="btn" id="authOpenBtn">ğŸ‘¤ ç™»å½•/æ³¨å†Œ</button>
<button class="btn" id="signOutBtn" style="display:none">ğŸšª é€€å‡º</button>
<button class="btn" id="cloudSaveBtn" style="display:none">â˜ äº‘ä¿å­˜</button>
<button class="btn" id="cloudLoadBtn" style="display:none">â˜ äº‘è¯»å–</button>
<span id="whoami" class="small muted"></span>

      </div>
      <div class="small">å©´å¹¼å„¿å‘å±•è¿½è¸ªä¸å®¶åº­æŒ‡å¯¼ç³»ç»Ÿ Â· å•æ–‡ä»¶ Â· é›¶ä¾èµ–</div>
    </div>

    <!-- é¦–é¡µå¡ç‰‡å¯¼èˆª -->
    <section class="card" id="home">
      <h1>è¯·é€‰æ‹©æ¨¡å—</h1>
      <div class="home-cards" id="homeCards"></div>
    </section>

    <div class="tabs" id="tabs"></div>

    <!-- 0 æŒ‡æ ‡æ›²çº¿ï¼ˆæŒ‰æœˆï¼‰ -->
    <section class="card" id="tab-0" hidden>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>æŒ‡æ ‡æ›²çº¿ï¼ˆæŒ‰æœˆï¼‰</h1>
        <a href="javascript:void(0)" class="small" onclick="goHome()">â† è¿”å›é¦–é¡µ</a>
      </div>
      <div class="grid-3">
        <div>
          <h2>é€‰æ‹©ç»´åº¦</h2>
          <div id="domainChips" class="chips"></div>
        </div>
        <div>
          <h2>é€‰æ‹©æœˆé¾„</h2>
          <select class="select" id="ageSelect"></select>
          <p class="small muted">å¯é€‰ï¼š6/12/18/24/30/36 æœˆã€‚</p>
        </div>
        <div>
          <h2>æ ‡å‡†çº¿</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="muted">åŸºå‡†åˆ†ï¼ˆ0â€“10ï¼‰</label>
            <input id="stdLine" class="input num" type="number" min="0" max="10" step="1" value="8" />
          </div>
        </div>
      </div>
      <div class="grid-2" style="margin-top:12px">
        <div class="card">
          <h2>æŒ‡æ ‡æ‰“åˆ†</h2>
          <table class="table">
            <thead><tr><th style="width:60%">æŒ‡æ ‡</th><th>åˆ†å€¼ï¼ˆ1â€“10ï¼‰</th></tr></thead>
            <tbody id="indicatorRows"></tbody>
          </table>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn" id="fillDemo">ç¤ºä¾‹å¡«å……</button>
            <button class="btn" id="clearThis">æ¸…ç©ºæœ¬æœˆæŒ‡æ ‡</button>
            <span class="muted small" id="saveHint"></span>
          </div>
        </div>
        <div class="card">
          <h2>æœ¬æœˆæŒ‡æ ‡æ›²çº¿</h2>
          <div class="chart-wrap" id="monthlyChart"></div>
          <p class="small muted">çºµè½´å›ºå®š 0â€“10ï¼›ç°è‰²è™šçº¿ä¸ºæ ‡å‡†çº¿ï¼›ç©ºå€¼æ–­å¼€ã€‚</p>
        </div>
      </div>
    </section>

    <!-- 1 èƒ½åŠ›æ›²çº¿ -->
    <section class="card" id="tab-1" hidden>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>èƒ½åŠ›æ›²çº¿ï¼ˆ6â€“36 æœˆï¼‰</h1>
        <a href="javascript:void(0)" class="small" onclick="goHome()">â† è¿”å›é¦–é¡µ</a>
      </div>
      <p class="muted small">è§„åˆ™ï¼šåŒä¸€ç»´åº¦æ¯ä¸ªå·²å½•å…¥æœˆé¾„çš„æŒ‡æ ‡<strong>å‡å€¼Ã—10</strong>ï¼ˆå››èˆäº”å…¥ï¼‰ï¼Œæœªå½•å…¥åˆ™æ–­ç‚¹ã€‚å¸¦çŠ¶ä¸ºå‚è€ƒçº¿ Â±10ã€‚</p>
      <div id="smallCharts" class="grid-2"></div>
    </section>

    <!-- 2 å®¶åº­ç¯å¢ƒ -->
    <section class="card" id="tab-2" hidden>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>å®¶åº­ç¯å¢ƒè¯„ä¼°</h1>
        <a href="javascript:void(0)" class="small" onclick="goHome()">â† è¿”å›é¦–é¡µ</a>
      </div>
      <p class="muted small">æ¯é¡¹ 1â€“5 åˆ†ï¼›ç‚¹å‡»â€œè®¡ç®—è¯„åˆ†â€ç”Ÿæˆå¹³å‡åˆ†ã€ç­‰çº§ä¸å»ºè®®ã€‚</p>
      <table class="table">
        <thead><tr><th style="width:18%">æ¡ç›®</th><th>æ ‡å‡†å€¼æè¿°</th><th style="width:160px">è¯„åˆ†ï¼ˆ1â€“5ï¼‰</th></tr></thead>
        <tbody id="homeRows"></tbody>
      </table>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="homeCalc">è®¡ç®—è¯„åˆ†</button>
        <button class="btn" id="homeClear">æ¸…ç©º</button>
        <button class="btn" id="homeSave">ä¿å­˜</button>
      </div>
      <div id="homeResult" class="card" style="margin-top:12px"></div>
    </section>

    <!-- 3 å¯¼å…¥å¯¼å‡º -->
    <section class="card" id="tab-3" hidden>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>å¯¼å…¥å¯¼å‡º / æŒä¹…åŒ–</h1>
        <a href="javascript:void(0)" class="small" onclick="goHome()">â† è¿”å›é¦–é¡µ</a>
      </div>
      <div class="grid-2">
        <div>
          <h2>å¯¼å‡º JSON</h2>
          <button class="btn" id="exportBtn">ä¸‹è½½ devtracker-data.json</button>
          <pre id="jsonPreview" class="card small" style="white-space:pre-wrap;margin-top:8px;max-height:300px;overflow:auto"></pre>
        </div>
        <div>
          <h2>å¯¼å…¥ JSON</h2>
          <input type="file" id="importFile" accept=".json" class="input" />
          <p class="muted small">é€‰æ‹©ç”±æœ¬å·¥å…·å¯¼å‡ºçš„ JSON è¦†ç›–æœ¬åœ°æ•°æ®ã€‚</p>
        </div>
      </div>
    </section>

    <!-- 4 æ•°æ®ç»Ÿè®¡ä»ªè¡¨æ¿ -->
    <section class="card" id="tab-4" hidden>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>æ•°æ®ç»Ÿè®¡ä»ªè¡¨æ¿</h1>
        <a href="javascript:void(0)" class="small" onclick="goHome()">â† è¿”å›é¦–é¡µ</a>
      </div>
      <p class="muted small">å±•ç¤ºæ¯ä¸ªç»´åº¦åœ¨ 6â€“36 æœˆçš„å¹³å‡åˆ†ï¼ˆ0â€“100ï¼‰ã€æ ‡å‡†å·®å’Œå¢é•¿é€Ÿç‡ï¼ˆçº¿æ€§å›å½’æ–œç‡ï¼Œåˆ†/æ¯6ä¸ªæœˆï¼‰ã€‚</p>
      <div id="statsTableWrap" class="card"></div>
      <div id="sparks" class="grid-4" style="margin-top:12px"></div>
    </section>

    <!-- 5 æ€¥æ•‘æŒ‡å— -->
    <section class="card" id="tab-5" hidden>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>æµ·å§†åˆ©å…‹æ€¥æ•‘æŒ‡å—</h1>
        <a href="javascript:void(0)" class="small" onclick="goHome()">â† è¿”å›é¦–é¡µ</a>
      </div>
      <div class="card" style="background:var(--bg)">
        <h2>2å²å®å®æ°”é“æ¢—é˜»æ€¥æ•‘æ­¥éª¤</h2>
        <ol class="guide-steps">
          <li><strong>è®©å®å®åç«‹æˆ–ç«™ç«‹</strong>ï¼ˆæˆ–æ–œåï¼‰ï¼Œæ–½æ•‘è€…ç«™åœ¨å®å®èº«åã€‚</li>
          <li><strong>åŒè‡‚ç¯æŠ±å®å®è…¹éƒ¨</strong>ï¼Œè®©å…¶èº«ä½“å¾®å€¾ã€‚</li>
          <li><strong>ä¸€æ‰‹æ¡æ‹³</strong>ï¼Œå°†æ‹‡æŒ‡é¡¶ä½å®å®è‚šè„ä¸Šæ–¹ä¸¤æ¨ªæŒ‡å¤„ã€‚</li>
          <li><strong>å¦ä¸€æ‰‹æŠ“ä½æ¡æ‹³æ‰‹</strong>ï¼Œå¿«é€Ÿå‘å†…ä¸Šæ–¹æŒ¤å‹å®å®è…¹éƒ¨ï¼Œç±»ä¼¼â€œå‘ä¸Šæâ€çš„åŠ¨ä½œã€‚</li>
          <li><strong>é‡å¤å¿«é€ŸæŒ¤å‹ 5 æ¬¡</strong>ï¼Œç›´åˆ°å¼‚ç‰©æ’å‡ºæˆ–å®å®å¤±å»æ„è¯†ã€‚</li>
        </ol>
      </div>
      <div class="card" style="background:var(--bg)">
        <h2>å©´å¹¼å„¿æ°”é“æ¢—é˜»é¢„é˜²æŒ‡å—</h2>
        <ul class="guide-bullets">
          <li>ä¸è¦ç»™ 3 å²ä»¥ä¸‹å„¿ç«¥å–‚é£Ÿåšæœã€ç¡¬ç³–ã€çˆ†ç±³èŠ±ç­‰å®¹æ˜“å™é£Ÿç‰©ã€‚</li>
          <li>å°†é£Ÿç‰©åˆ‡æˆå°å—ï¼Œä¿æŒè½¯çƒ‚ã€æ–¹ä¾¿å®å®åå’½ã€‚</li>
          <li>è¿›é£Ÿæ—¶ä¿æŒåå§¿ï¼Œ<strong>ä¸è¦åœ¨è·‘åŠ¨ã€å¤§ç¬‘æˆ–å“­é—¹æ—¶è¿›é£Ÿ</strong>ã€‚</li>
          <li>é¿å…è®©å®å®ç©è€<strong>å°äº 4 å˜ç±³</strong>çš„å°ç©å…·æˆ–å°ç‰©å“ï¼Œå¹¶æ£€æŸ¥æ˜“è„±è½å°é›¶ä»¶ã€‚</li>
          <li>ä¸è¦æŠŠç¡¬å¸ã€çº½æ‰£ç­‰<strong>å°ç‰©ä»¶</strong>æ”¾å…¥å£ä¸­ï¼›å“­é—¹æ—¶å‹¿å¼ºè¡Œå–‚é£Ÿã€‚</li>
        </ul>
      </div>
      <div class="alert-bar">
        <strong>ç´§æ€¥æƒ…å†µè¯·ç«‹å³æ‹¨æ‰“æ€¥æ•‘ç”µè¯ï¼š120</strong><br>
        åœ¨ç­‰å¾…ä¸“ä¸šæ•‘æ´æ—¶ï¼ŒæŒç»­å®æ–½æ€¥æ•‘æªæ–½ï¼Œå¹¶æ³¨æ„è‡ªèº«å®‰å…¨ã€‚
      </div>
    </section>

    <!-- 6 äº²å­å…±é¤æŒ‡å¯¼äº’åŠ¨ -->
    <section class="card" id="tab-6" hidden>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>äº²å­å…±é¤æŒ‡å¯¼äº’åŠ¨é¡µ</h1>
        <a href="javascript:void(0)" class="small" onclick="goHome()">â† è¿”å›é¦–é¡µ</a>
      </div>
      <div class="feed-card">
        <h2>ğŸ½ å–‚é¥­å§¿åŠ¿æ¼”ç¤º</h2>
        <div class="feed-row">
          <svg class="feed-svg" viewBox="0 0 120 120" aria-label="å–‚é¥­å§¿åŠ¿SVG">
            <rect x="5" y="70" width="110" height="35" rx="6" fill="#e5e7eb"/>
            <circle cx="35" cy="55" r="16" fill="#93c5fd"/>
            <rect x="50" y="45" width="55" height="20" rx="4" fill="#2563eb"/>
            <circle cx="95" cy="55" r="10" fill="#facc15"/>
            <line x1="60" y1="55" x2="85" y2="55" stroke="#fff" stroke-width="2"/>
          </svg>
          <div>
            <p>ä¸å®å®<strong>é¢å¯¹é¢</strong>ï¼Œè·ç¦»çº¦ <strong>30â€“40 å˜ç±³</strong>ï¼›å®å®åç¨³å®‰å…¨åº§æ¤…å¹¶ç³»å¥½å›ºå®šå¸¦ã€‚</p>
            <p class="feed-tip">é¿å…ç«™ç«‹å–‚é¥­ã€è¿½å–‚æˆ–è¾¹ç©è¾¹å–‚ï¼›ä¿æŒå¹³å’Œè¯­æ°”ä¸ç¨³å®šèŠ‚å¥ã€‚</p>
          </div>
        </div>
      </div>

      <div class="feed-card">
        <h2>ğŸ—£ å…±é¤å£ä»¤æç¤ºï¼ˆè½»éŸ³æ•ˆï¼‰</h2>
        <button class="toggle-btn" id="cmdBtn">â–¶ æ’­æ”¾â€œå¼ å˜´â€”å’¬ä¸€å£â€”çœŸæ£’ï¼â€èŠ‚å¥</button>
        <ul class="guide-bullets" style="margin-top:6px">
          <li>å¼ å˜´ â€”â€” <strong>å’¬ä¸€å£</strong> â€”â€” çœŸæ£’ï¼</li>
          <li>åå’½ â€”â€” <strong>æ“¦å˜´å·´</strong> â€”â€” å¾®ç¬‘è¡¨æ‰¬ã€‚</li>
          <li>å–æ°´ â€”â€” <strong>æ”¾å‹ºå­</strong> â€”â€” æ‹æ‹æ‰‹ï¼</li>
        </ul>
        <p class="feed-tip">æç¤ºï¼šä¸ºä¿è¯ç¦»çº¿å¯ç”¨ï¼Œæˆ‘ä»¬ä½¿ç”¨æµè§ˆå™¨ WebAudio åˆæˆçŸ­ä¿ƒâ€œå“”â€éŸ³æ›¿ä»£çœŸäººè¯­éŸ³ã€‚</p>
      </div>

      <div class="feed-card">
        <h2>âš ï¸ é£é™©æé†’</h2>
        <p>è‹¥å‡ºç°å‘›å’³ï¼š<strong>ç«‹å³åœæ­¢å–‚é£Ÿ</strong>ï¼Œè®©å®å®å‰å€¾æ‹èƒŒ 3â€“5 æ¬¡ã€‚</p>
        <p>å¦‚æŒç»­å’³å—½æˆ–è„¸è‰²å‘é’ï¼Œ<strong>æ‰§è¡Œæµ·å§†åˆ©å…‹æ³•å¹¶å‘¼å«120</strong>ã€‚</p>
        <p class="feed-tip">å…±é¤æ—¶ä¿æŒè€å¿ƒï¼Œç”¨è¯­è¨€å¼•å¯¼è€Œéå¼ºè¿«è¿›é£Ÿã€‚</p>
      </div>

      <div class="feed-card">
        <h2>ğŸ˜‹ å®å®è¡¨æƒ…è´´çº¸åŒº</h2>
        <div class="stickers" id="stickers">
          <div class="sticker active" data-state="happy" title="å¼€å¿ƒ">ğŸ˜‹</div>
          <div class="sticker" data-state="resist" title="æŠ—æ‹’">ğŸ˜£</div>
          <div class="sticker" data-state="satisfied" title="æ»¡è¶³">ğŸ˜Œ</div>
        </div>
        <p id="stickerText" class="feed-tip">å½“å‰çŠ¶æ€ï¼šå¼€å¿ƒ â€”â€” ç»§ç»­ä¿æŒè½»æ¾äº’åŠ¨ä¸æ­£å‘åé¦ˆã€‚</p>
      </div>
    </section>

    <div class="footer small">Â© 2025 å©´å¹¼å„¿å‘å±•è¿½è¸ªä¸å®¶åº­æŒ‡å¯¼ç³»ç»Ÿ Â· å•æ–‡ä»¶ Â· é›¶ä¾èµ– Â· SVG æŠ˜çº¿å›¾</div>
  </div>

<script>
/* ========== å¸¸é‡ä¸åˆå§‹åŒ– ========== */
const DOMAINS=['è®¤çŸ¥èƒ½åŠ›','æ•°å­¦é€»è¾‘','è¯­è¨€èƒ½åŠ›','å¤§åŠ¨ä½œèƒ½åŠ›','ç²¾ç»†åŠ¨ä½œèƒ½åŠ›','è‰ºæœ¯è¡¨ç°','è‡ªç†èƒ½åŠ›','äº¤å¾€èƒ½åŠ›'];
const AGE_LIST=[6,12,18,24,30,36];
const REF_BAND=10;
const STORE_KEY='devtracker_final';

/* æŒ‡æ ‡æ–‡æœ¬ï¼ˆæ¯ç»´åº¦æ¯æœˆé¾„çº¦5æ¡ï¼‰ */
const INDICATOR_TEXT={
 'è®¤çŸ¥èƒ½åŠ›':{6:['ç›®å…‰è¿½éšç§»åŠ¨ç‰©ä½“','æ³¨è§†æ—¶é•¿â‰¥3ç§’','å¯»æ‰¾éƒ¨åˆ†é®æŒ¡çš„ç©å…·','åˆ†è¾¨ç†Ÿäºº/é™Œç”Ÿäººè¡¨æƒ…','å¯¹æ–°å¥‡åˆºæ¿€è½¬å¤´å®šä½'],
 12:['ç‰©ä½“æ°¸ä¹…æ€§åˆæ˜¾','ä¸¤æ­¥å› æœæ¢ç´¢ï¼ˆæ‹/æ¨ï¼‰','æ¨¡ä»¿ç®€å•åŠ¨ä½œ','æ³¨æ„åŠ›è½¬ç§»','æ¢ç´¢å¼æ•²æ‰“/æ‘‡æ™ƒ'],
 18:['ä¸‰æ­¥å› æœæ¢ç´¢','åŠŸèƒ½æ€§ä½¿ç”¨ç‰©å“','ç®€æ˜“åˆ†ç±»é…å¯¹','æŒ‡è®¤ç†Ÿæ‚‰ç‰©ä½“','å°è¯•è§£é”/æ‰“å¼€'],
 24:['ä¸¤æ­¥è§„åˆ™å®Œæˆ','æŒ‰é¢œè‰²æˆ–å½¢çŠ¶åˆ†ç±»','ç®€å•æ‹¼æ­','è®°ä½2æ­¥æŒ‡ä»¤','ç‹¬ç«‹æ¢ç´¢é¡ºåº'],
 30:['ç®€å•é—®é¢˜æ±‚è§£','3ç±»ä»¥ä¸Šåˆ†ç±»','æ‹¼å›¾3â€“4å—','å› æœæ¨æ–­å¢å¼º','æƒ…å¢ƒä¸­å›å¿†'],
 36:['å¤šæ­¥éª¤è§„åˆ™','æ•°é‡å®ˆæ’åˆæ˜¾','6å—æ‹¼å›¾','ç®€å•è§’è‰²æ‰®æ¼”è§„åˆ’','å»¶è¿Ÿæ»¡è¶³']},
 'æ•°å­¦é€»è¾‘':{6:['æ³¨è§†æ•°é‡å·®å¼‚','è¿½è§†æ•°é‡å˜åŒ–','å¯¹èŠ‚å¥æœ‰ååº”','å¯¹é‡å¤äº§ç”ŸæœŸå¾…','çŸ­æ—¶è®°å¿†2ç§’'],
 12:['ç†è§£â€œæ›´å¤š/æ›´å°‘â€','æ‹æ‰‹æŒ‰èŠ‚å¥','é…å¯¹ç›¸åŒç‰©ä½“','æŒ‰å¤§å°æ’ä¸¤çº§','å¯¹â€œä¸€ä¸ª/ä¸¤ä¸ªâ€æ•æ„Ÿ'],
 18:['å£å¤´ç‚¹æ•°1-3','æŒ‰å¤§å°æ’åº3çº§','ç®€å•å›¾å½¢é…å¯¹','å®Œæˆ2æ­¥æ‹¼æ’','æ¯”è¾ƒå¤šå°‘'],
 24:['ç‚¹æ•°åˆ°5','æŒ‰ç±»èšåˆ3ç»„','ç®€å•æ¨¡å¼ABAB','åŒ¹é…æ•°å­—1-3','æ¯”è¾ƒé•¿çŸ­é«˜ä½'],
 30:['ç‚¹æ•°åˆ°7','å»¶ç»­æ¨¡å¼AAB','3ç»´åˆ†ç±»','ç†è§£0æ¦‚å¿µåˆæ˜¾','ç®€å•åŠ ä¸€'],
 36:['ç‚¹æ•°åˆ°10','å¤æ‚æ¨¡å¼ABC','æ¯”è¾ƒå·®å€¼','å›¾å½¢ç»„æˆ','ç®€å•å‡ä¸€']},
 'è¯­è¨€èƒ½åŠ›':{6:['å¯¹åå­—æœ‰ååº”','å’¿å‘€å‘å£°','è½¬å¤´å¯»æ‰¾å£°éŸ³','é«˜å…´æ—¶ç¬‘å£°','æ¨¡ä»¿éŸ³èŠ‚'],
 12:['ä¼šè¯´1-3ä¸ªè¯','ç†è§£â€œä¸è¦â€','æŒ‡ç‰©å‘½å','æ‰‹åŠ¿è¡¨è¾¾','å¬æ‡‚ç†Ÿæ‚‰æŒ‡ä»¤'],
 18:['ä¼šè¯´10+è¯','ä¸¤è¯çŸ­è¯­','å‘½åå¸¸è§ç‰©','ç†è§£â€œç»™æˆ‘â€','æ¨¡ä»¿æ–°è¯'],
 24:['ä¸‰è¯å¥','æé—®â€œè¿™æ˜¯ä»€ä¹ˆâ€','ç†è§£æ–¹ä½è¯','è®²è¿°ç®€å•éœ€è¦','è·Ÿè¯»çŸ­å¥'],
 30:['å››è¯å¥','è®²è¿°ç»å†ç‰‡æ®µ','ç†è§£å¤åˆæŒ‡ä»¤','åŸºæœ¬æ—¶æ€æ„è¯†','å¤è¿°æ•…äº‹è¦ç‚¹'],
 36:['è¿è´¯è¡¨è¾¾','ä½¿ç”¨å› æœè¿è¯','ç†è§£å¤æ‚ç–‘é—®','æƒ…ç»ªè¨€è¯­è¡¨è¾¾','è®²è¿°å®Œæ•´ç»å†']},
 'å¤§åŠ¨ä½œèƒ½åŠ›':{6:['æŠ¬å¤´ç¨³å®š','ç¿»èº«','ä¿¯å§æ”¯æ’‘','åå§¿è¾…åŠ©','æŠ“æ¡æ”¯æ’‘'],
 12:['ç‹¬ç«™ç‰‡åˆ»','æ‰¶ç‰©èµ°','è¹²èµ·','æ”€çˆ¬ä½å°é˜¶','æŠ›æ·å¤§çƒ'],
 18:['ç‹¬èµ°ç¨³','åé€€æ•°æ­¥','åŠ©è·‘è¸¢çƒ','è·¨å°éšœç¢','æ¬è¿å°ç‰©'],
 24:['åŒè„šèµ·è·³','ä¸Šä¸‹å°é˜¶æ‰¶æ ','æ¥æ»šæ¥çš„çƒ','å¹³è¡¡æœ¨è¿ˆæ­¥','çŸ­è·ç¦»è·‘'],
 30:['å•è„šç«™1-2ç§’','åŒè„šè·³å‰è¿›','ä¸Šæ¥¼äº¤æ›¿æ­¥','è¸¢çƒæ›´å‡†','è½¬èº«è·‘åœ'],
 36:['å•è„šè·³','ä¸‹æ¥¼äº¤æ›¿æ­¥','æŠ›æ¥è½»çƒ','30ç§’å¹³è¡¡','åŸåœ°è¿ç»­è·³']},
 'ç²¾ç»†åŠ¨ä½œèƒ½åŠ›':{6:['æŠ“æ¡æ‘‡é“ƒ','åŒæ‰‹ä¼ ç‰©','æ•²æ‰“æ¡Œé¢','æ’®æ¡å°è¯•','æ³¨è§†æ‰‹éƒ¨'],
 12:['æ‹‡é£ŸæŒ‡æ','ç¿»ä¹¦é¡µ','æŠŠç§¯æœ¨æ”¾ç›’','æ¶‚é¸¦ç—•è¿¹','æ’æ£’å¤§å­”'],
 18:['å †2-3å—','ç”»ç›´çº¿ç—•è¿¹','ç©¿å¤§å­”ç»³','ç¿»ä¹¦å¤šé¡µ','æ‹¨åŠ¨å¼€å…³'],
 24:['å †5å—','ç”»åœ†åœˆç—•è¿¹','è½¬åŠ¨æ—‹é’®','æ’•çº¸æ¡','æ‹¼æ’å½¢çŠ¶å—'],
 30:['å‰ªçº¸ç›´çº¿','ç”»åå­—ç—•è¿¹','æ‰£å¤§æ‰£å­','æ‹§ç“¶ç›–','å¤¹å–å°ç‰©'],
 36:['æç”»ç®€å•å½¢','ç©¿ç å­','å‰ªçº¸æ›²çº¿','ç”»äººå¤´è¶³','ä½¿ç”¨å‹ºå‰å‡†']},
 'è‰ºæœ¯è¡¨ç°':{6:['å¯¹éŸ³ä¹å¾®ç¬‘','éšèŠ‚å¥æ‘†åŠ¨','æ³¨è§†è‰²å½©','æ¨¡ä»¿éŸ³é«˜','æ‹æ‰‹åº”å’Œ'],
 12:['éšéŸ³ä¹å¾‹åŠ¨','é€‰æ‹©å–œæ¬¢ä¹å™¨','å æ”¾å½©å—','æ¨¡ä»¿è¡¨æƒ…','è‡ªç”±æ¶‚é¸¦'],
 18:['èŠ‚å¥å¾‹åŠ¨å‡†ç¡®','ç”¨è‰²å—é…è‰²','å”±ç®€çŸ­æ—‹å¾‹','è§’è‰²æ¨¡ä»¿','ç”¨çº¿æ¡è¡¨è¾¾'],
 24:['è·Ÿå”±å„¿æ­Œ','é¢œè‰²æ­é…2-3è‰²','æ¨¡ä»¿ç”»å½¢','èŠ‚å¥é“å…·ä½¿ç”¨','è§’è‰²æ‰®æ¼”'],
 30:['è‡ªä¸»æ­Œå”±','ç»˜ç”»åŸºæœ¬å½¢çŠ¶','èŠ‚å¥å˜æ¢','æ­å»ºä¸»é¢˜ä½œå“','è®²è¿°ä½œå“'],
 36:['åˆ›ç¼–æ—‹å¾‹','ä¸»é¢˜ç»˜ç”»å®Œæ•´','èŠ‚å¥æŒ‡æŒ¥','èˆè¹ˆç»„åˆ','æˆå‰§æ€§è¡¨è¾¾']},
 'è‡ªç†èƒ½åŠ›':{6:['é…åˆå–‚å…»','æ¡å¥¶ç“¶','å¯¹ç©¿è¡£æœ‰ååº”','æ‹èƒŒå…¥ç¡','è§„å¾‹æ’ä¾¿åˆæ˜¾'],
 12:['ç”¨æ¯å–æ°´','å¸®å¿™ä¼¸æ‰‹è„š','å°è¯•ç”¨å‹º','æŒ‡ç¤ºçº¸å°¿è£¤æ¹¿äº†','å…¥ç¡è§„å¾‹'],
 18:['è„±ç®€å•è¡£ç‰©','ç‹¬ç«‹ç”¨å‹ºéƒ¨åˆ†æˆåŠŸ','æ´—æ‰‹é…åˆ','ç¤ºæ„å¦‚å•','ç©¿é‹å°è¯•'],
 24:['åŸºæœ¬ç”¨å‹º','ç©¿è„±éƒ¨åˆ†è¡£ç‰©','ååŠ©åˆ·ç‰™','å¦‚å•è®­ç»ƒä¸­','æ”¶æ‹¾ç©å…·'],
 30:['ç‹¬ç«‹ç”¨å‹º/å‰','ç©¿è„±ç®€å•è¡£ç‰©','ç®€å•åˆ·ç‰™æ¼±å£','æ´—æ‰‹æµç¨‹','æ•´ç†ä¸ªäººç‰©å“'],
 36:['ç‹¬ç«‹è¿›é¤','ç©¿è„±è¡£è£¤é‹è¢œ','ç‹¬ç«‹å¦‚å•','ç®€å•å®¶åŠ¡','å®‰å…¨è‡ªæŠ¤æ„è¯†']},
 'äº¤å¾€èƒ½åŠ›':{6:['æ³¨è§†äººè„¸','å¯¹ç¬‘å®¹å›åº”','å¯¹æŠ±èµ·æœ‰ååº”','è·Ÿéšæˆäººç›®å…‰','åŸºæœ¬åˆ†ç¦»ç„¦è™‘'],
 12:['é™Œç”Ÿæƒ…å¢ƒå›é¿','ä¸æˆäººäº’åŠ¨æ¸¸æˆ','ä¸åŒä¼´å¹³è¡Œæ¸¸æˆ','åˆ†äº«å…´è¶£','ç¤¾ä¼šæ€§å¾®ç¬‘'],
 18:['ä¸åŒä¼´æœ‰äº’åŠ¨','è½®æµç­‰å¾…åˆæ˜¾','è¡¨è¾¾æƒ…ç»ªéœ€æ±‚','æ¨¡ä»¿åŒä¼´','å®‰æ…°ä»–äººå°è¯•'],
 24:['åˆä½œæ¸¸æˆ','éµå®ˆç®€å•è§„åˆ™','åˆ†äº«è½®æµ','è¡¨è¾¾åŒç†','ä¸åŒä¼´ååŒ'],
 30:['å°ç»„åˆä½œ','å†²çªåå•†','éµå®ˆå®¶åº­è§„åˆ™','è§’è‰²åä½œ','è¡¨è¾¾ç¤¼è²Œ'],
 36:['åŒä¼´åä½œä»»åŠ¡','è§„åˆ™æ¸¸æˆ','è§£å†³å†²çª','é¢†å¯¼æˆ–è·Ÿéšè§’è‰²','ç†è§£ç¤¾ä¼šè§„èŒƒ']}
};

const REF_DEFAULT={
  'è®¤çŸ¥èƒ½åŠ›':[40,55,65,75,82,88],
  'æ•°å­¦é€»è¾‘':[35,50,60,70,78,85],
  'è¯­è¨€èƒ½åŠ›':[30,48,60,72,80,88],
  'å¤§åŠ¨ä½œèƒ½åŠ›':[45,60,70,80,88,92],
  'ç²¾ç»†åŠ¨ä½œèƒ½åŠ›':[32,48,60,72,80,88],
  'è‰ºæœ¯è¡¨ç°':[30,45,58,70,78,86],
  'è‡ªç†èƒ½åŠ›':[28,44,58,70,82,90],
  'äº¤å¾€èƒ½åŠ›':[34,50,62,74,82,90]
};

/* çŠ¶æ€ */
let indicatorScores = loadScores() || initScores();
let curDomain = DOMAINS[0];
let curAge = AGE_LIST[0];

/* é¡¶éƒ¨æ§ä»¶ */
document.getElementById('themeBtn').onclick=()=>{
  const root=document.documentElement; const now=root.getAttribute('data-theme')||'light';
  root.setAttribute('data-theme', now==='light'?'dark':'light');
  saveScores(false);
};
document.getElementById('printBtn').onclick=()=>window.print();
document.getElementById('resetBtn').onclick=()=>{
  if(confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')){
    localStorage.removeItem(STORE_KEY);
    indicatorScores=initScores(); curDomain=DOMAINS[0]; curAge=AGE_LIST[0];
    renderAll();
  }
};

/* é¦–é¡µå¡ç‰‡ */
const modules=[
  ['æŒ‡æ ‡æ›²çº¿ï¼ˆæŒ‰æœˆï¼‰','å½•å…¥æœˆé¾„æŒ‡æ ‡å¹¶ç”Ÿæˆå½“æœˆæŠ˜çº¿å›¾ï¼Œç›´è§‚è§‚å¯Ÿæˆé•¿è¶‹åŠ¿ã€‚'],
  ['èƒ½åŠ›æ›²çº¿ï¼ˆ6â€“36æœˆï¼‰','8 ä¸ªç»´åº¦çš„å°å›¾å±•ç¤º 6â†’36 æœˆé¾„èƒ½åŠ›å˜åŒ–ã€‚'],
  ['å®¶åº­ç¯å¢ƒè¯„ä¼°','12 ä¸ªæ¡ç›®å¿«é€Ÿè¯„ä¼°ç¯å¢ƒè´¨é‡å¹¶ç”Ÿæˆå»ºè®®ã€‚'],
  ['æ•°æ®ç»Ÿè®¡ä»ªè¡¨æ¿','ç»Ÿè®¡å‡å€¼ã€æ ‡å‡†å·®ä¸å¢é•¿é€Ÿç‡ã€‚'],
  ['æ€¥æ•‘æŒ‡å—','æµ·å§†åˆ©å…‹æ“ä½œä¸é¢„é˜²è¦ç‚¹ï¼Œç´§æ€¥æ‹¨æ‰“ 120ã€‚'],
  ['äº²å­å…±é¤æŒ‡å¯¼','å–‚é¥­å§¿åŠ¿ã€å£ä»¤èŠ‚å¥ä¸é£é™©æé†’ï¼Œå«è¡¨æƒ…äº’åŠ¨ã€‚']
];
const homeCards=document.getElementById('homeCards');
modules.forEach((m,i)=>{
  const div=document.createElement('div');
  div.className='home-card';
  div.innerHTML=`<h3>${m[0]}</h3><p class="muted">${m[1]}</p><div><button class="btn">è¿›å…¥æ¨¡å—</button></div>`;
  div.querySelector('button').onclick=()=>switchTab(i);
  homeCards.appendChild(div);
});

/* é€‰é¡¹å¡ */

const tabIdMap=[0,1,2,4,5,6]; // æ˜ å°„å¯è§æ¨¡å— -> å®é™… section IDï¼ˆè·³è¿‡å¯¼å…¥å¯¼å‡º:3ï¼‰

const tabDefs=modules.map(m=>m[0]);
const tabsEl=document.getElementById('tabs');
tabDefs.forEach((t,i)=>{
  const b=document.createElement('button'); b.className='tab'; b.textContent=t; b.onclick=()=>switchTab(i);
  tabsEl.appendChild(b);
});
function goHome(){
  document.getElementById('home').hidden=false;
  for(let i=0;i<tabDefs.length;i++){ document.getElementById('tab-'+tabIdMap[i]).hidden=true; tabsEl.children[i].classList.remove('active'); }
  window.scrollTo({top:0,behavior:'smooth'});
}
function switchTab(idx){
  const tabId = tabIdMap[idx];
  document.getElementById('home').hidden=true;
  for(let i=0;i<tabDefs.length;i++){
    document.getElementById('tab-'+tabIdMap[i]).hidden = i!==idx;
    tabsEl.children[i].classList.toggle('active', i===idx);
  }
  if(tabId===1){ renderSmallCharts(true); }
  if(tabId===4){ renderStats(); }
  window.scrollTo({top:0,behavior:'smooth'});
}

/* æŒ‡æ ‡é¡µï¼šç»´åº¦ä¸æœˆé¾„æ§ä»¶ */
const chipsEl=document.getElementById('domainChips');
DOMAINS.forEach((d,i)=>{
  const c=document.createElement('button');
  c.className='chip'+(i===0?' active':'');
  c.textContent=d; c.onclick=()=>setDomain(d);
  chipsEl.appendChild(c);
});
const ageSelect=document.getElementById('ageSelect');
AGE_LIST.forEach(a=>{ const o=document.createElement('option'); o.value=a; o.textContent=a+' æœˆ'; ageSelect.appendChild(o); });
ageSelect.onchange=()=>setAge(parseInt(ageSelect.value));

document.getElementById('fillDemo').onclick=demoFill;
document.getElementById('clearThis').onclick=clearThisMonth;
document.getElementById('stdLine').onchange=renderMonthlyChart;

/* å®¶åº­ç¯å¢ƒæ•°æ® */
const HOME_ITEMS=[
  ['ä½œæ¯','å›ºå®šä½œæ¯ã€ç¨³å®šæ˜¼å¤œèŠ‚å¾‹','1=æ— è§„å¾‹; 3=åŸºæœ¬è§„å¾‹; 5=ç¨³å®šè§„å¾‹'],
  ['å®‰å…¨','ç”¨ç”µ/å®¶å…·/è¾¹è§’/é—¨çª—é˜²æŠ¤å®Œå–„','1=éšæ‚£å¤š; 3=éƒ¨åˆ†é˜²æŠ¤; 5=é˜²æŠ¤å®Œå–„'],
  ['å›åº”æ€§','æˆäººå¯¹ä¿¡å·åŠæ—¶å›åº”','1=å¿½è§†; 3=ä¸€èˆ¬; 5=æ•æ„Ÿå›åº”'],
  ['è¯­è¨€ç¯å¢ƒ','æœ‰äº’åŠ¨æ€§è¯­è¨€ä¸æŒ‡ä»¤','1=æå°‘äº’åŠ¨; 3=ä¸€èˆ¬; 5=ä¸°å¯Œäº’åŠ¨'],
  ['äº²å­é˜…è¯»','æ¯å‘¨æœ‰å›ºå®šäº²å­é˜…è¯»','1=æ— ; 3=æ¯å‘¨1-2æ¬¡; 5=æ¯æ—¥15min+'],
  ['æ¸¸æˆææ–™','é€‚é¾„å®‰å…¨ã€å¼€æ”¾æ€§ææ–™','1=åŒ®ä¹; 3=åŸºæœ¬å¤Ÿ; 5=ä¸°å¯Œå¤šæ ·'],
  ['å±å¹•æš´éœ²','æ—¶é•¿ä¸å†…å®¹å¯æ§','1=è¶…2h/æ—¥; 3=<1h/æ—¥; 5=å‡ ä¹ä¸ç”¨'],
  ['ç¡çœ ç¯å¢ƒ','å®‰é™ã€å…‰ç…§ä¸æ¸©æ¹¿é€‚å®œ','1=å·®; 3=ä¸€èˆ¬; 5=è‰¯å¥½'],
  ['è¥å…»å–‚å…»','å‡è¡¡é¥®é£Ÿä¸è§„å¾‹åŠ é¤','1=åé£Ÿä¸¥é‡; 3=åŸºæœ¬å‡è¡¡; 5=å‡è¡¡è§„å¾‹'],
  ['å«ç”Ÿæ¶ˆæ¯’','è‰¯å¥½å«ç”Ÿä¹ æƒ¯','1=å·®; 3=ä¸€èˆ¬; 5=è‰¯å¥½'],
  ['ç¤¾ä¼šäº’åŠ¨','æœ‰é«˜è´¨é‡åŒä¼´/æˆäººäº’åŠ¨','1=å¾ˆå°‘; 3=å¶å°”; 5=ç»å¸¸'],
  ['å®¶é•¿å‹åŠ›','å®¶é•¿å‹åŠ›å¯è°ƒèŠ‚','1=é«˜å‹; 3=å¯æ§; 5=è‰¯å¥½è°ƒèŠ‚']
];
let homeScores = Array(12).fill(3);

/* ========== SVG ç»˜å›¾å·¥å…· ========== */
function createSVG(w,h){ const svg=document.createElementNS('http://www.w3.org/2000/svg','svg'); svg.setAttribute('viewBox',`0 0 ${w} ${h}`); svg.setAttribute('role','img'); return svg; }
function linePath(points){ return points.map((p,i)=> (i?'L':'M')+p[0].toFixed(2)+','+p[1].toFixed(2)).join(' '); }
function segmentedPath(points){ let d='', seg=[]; points.forEach(p=>{ if(p===null){ if(seg.length>1){ d+=(d?' ':'')+linePath(seg);} seg=[];} else{ seg.push(p);} }); if(seg.length>1){ d+=(d?' ':'')+linePath(seg);} return d; }
function renderGrid(svg, x0,y0, w,h, yMin,yMax,yStep){
  const g=document.createElementNS(svg.namespaceURI,'g');
  for(let y=yMin; y<=yMax; y+=yStep){
    const yy = y0 + h - (y - yMin) / (yMax - yMin) * h;
    const line=document.createElementNS(svg.namespaceURI,'line');
    line.setAttribute('x1',x0); line.setAttribute('x2',x0+w); line.setAttribute('y1',yy); line.setAttribute('y2',yy);
    line.setAttribute('stroke','var(--line)'); line.setAttribute('stroke-width','1');
    g.appendChild(line);
    const txt=document.createElementNS(svg.namespaceURI,'text');
    txt.setAttribute('x', x0-6); txt.setAttribute('y', yy+4);
    txt.setAttribute('text-anchor','end'); txt.setAttribute('font-size','12'); txt.setAttribute('fill','var(--fg)');
    txt.textContent = y;
    g.appendChild(txt);
  }
  svg.appendChild(g);
}
function renderXAxis(svg, x0,y0,w,h, labels){
  const g=document.createElementNS(svg.namespaceURI,'g');
  const n=labels.length;
  for(let i=0;i<n;i++){
    const xx=x0 + (n===1?0:(i*(w/(n-1))));
    const txt=document.createElementNS(svg.namespaceURI,'text');
    txt.setAttribute('x',xx); txt.setAttribute('y', y0+h+16);
    txt.setAttribute('text-anchor','middle'); txt.setAttribute('font-size','12'); txt.setAttribute('fill','var(--fg)');
    txt.textContent=labels[i];
    g.appendChild(txt);
  }
  svg.appendChild(g);
}
function toPoints(values, x0,y0,w,h, yMin,yMax){
  const n=values.length; const pts=[];
  for(let i=0;i<n;i++){
    const v=values[i];
    if(v===null || typeof v!=='number'){ pts.push(null); continue; }
    const x=x0 + (n===1?0:(i*(w/(n-1))));
    const y=y0 + h - (v - yMin)/(yMax - yMin)*h;
    pts.push([x,y]);
  }
  return pts;
}
function drawPath(svg, d, stroke, width, dash){
  const p=document.createElementNS(svg.namespaceURI,'path');
  p.setAttribute('d', d); p.setAttribute('fill','none'); p.setAttribute('stroke', stroke); p.setAttribute('stroke-width', width);
  if(dash) p.setAttribute('stroke-dasharray', dash);
  svg.appendChild(p);
}
function drawPoints(svg, points, radius){
  points.forEach(p=>{
    if(!p) return;
    const c=document.createElementNS(svg.namespaceURI,'circle');
    c.setAttribute('cx', p[0]); c.setAttribute('cy', p[1]); c.setAttribute('r', radius);
    c.setAttribute('fill','currentColor');
    svg.appendChild(c);
  });
}
function avg10(arr){ const vals=arr.filter(v=>typeof v==='number'); if(!vals.length) return null; const avg=vals.reduce((a,b)=>a+b,0)/vals.length; return Math.round(avg*10); }
function buildDomainSeries(domain){ return AGE_LIST.map(a=>avg10(indicatorScores[domain]?.[a]||[])); }

/* ========== æœˆåº¦å›¾æ¸²æŸ“ä¸è¡¨ ========== */
function renderMonthlyChart(){
  const wrap=document.getElementById('monthlyChart');
  wrap.innerHTML='';
  const labels=(INDICATOR_TEXT[curDomain]?.[curAge]||[]).map((_,i)=>'æŒ‡æ ‡'+(i+1));
  const real=indicatorScores[curDomain]?.[curAge]||[];
  const stdv=parseInt(document.getElementById('stdLine').value||'8');
  const std=labels.map(()=>stdv);

  const W=720, H=300, x0=50, y0=10, w=W-70, h=230;
  const svg=createSVG(W,H);
  renderGrid(svg, x0,y0,w,h, 0,10,2);
  renderXAxis(svg, x0,y0,w,h, labels);

  // æ ‡å‡†çº¿ï¼ˆç°è™šçº¿ï¼‰
  const stdPts=toPoints(std, x0,y0,w,h, 0,10);
  const stdD=segmentedPath(stdPts);
  drawPath(svg, stdD, '#9ca3af', 2, '6,6');

  // å®é™…å€¼
  const realPts=toPoints(real, x0,y0,w,h, 0,10);
  const realD=segmentedPath(realPts);
  drawPath(svg, realD, 'currentColor', 2);
  drawPoints(svg, realPts, 3);

  wrap.appendChild(svg);
}

function setDomain(d){
  curDomain=d;
  [...document.querySelectorAll('.chip')].forEach(c=>c.classList.toggle('active', c.textContent===d));
  updateIndicatorsTable(); renderMonthlyChart();
}
function setAge(a){ curAge=a; document.getElementById('ageSelect').value=String(a); updateIndicatorsTable(); renderMonthlyChart(); }
function updateIndicatorsTable(){
  const tbody=document.getElementById('indicatorRows'); tbody.innerHTML='';
  const texts=INDICATOR_TEXT[curDomain]?.[curAge]||[];
  const scores=indicatorScores[curDomain]?.[curAge]||[];
  texts.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t}</td><td><input class="input num" type="number" min="1" max="10" step="1" value="${scores[i]??''}" data-idx="${i}" /></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('input').forEach(inp=>{
    inp.onchange=()=>{
      const i=parseInt(inp.dataset.idx);
      const v=inp.value===''?null:Math.max(1,Math.min(10,parseInt(inp.value)));
      inp.value=v===null?'':String(v);
      indicatorScores[curDomain][curAge][i]=v;
      saveScores(true); renderMonthlyChart(); renderSmallCharts(true);
    };
  });
}
function demoFill(){
  const arr=indicatorScores[curDomain][curAge];
  for(let i=0;i<arr.length;i++){ arr[i]=Math.floor(6+Math.random()*5); }
  saveScores(true); updateIndicatorsTable(); renderMonthlyChart(); renderSmallCharts(true);
}
function clearThisMonth(){
  const arr=indicatorScores[curDomain][curAge];
  for(let i=0;i<arr.length;i++){ arr[i]=null; }
  saveScores(true); updateIndicatorsTable(); renderMonthlyChart(); renderSmallCharts(true);
}

/* ========== å°å›¾ä¸ä»ªè¡¨æ¿ ========== */
function renderSmallChart(dom, container){
  const base=REF_DEFAULT[dom]||[40,55,65,75,82,88];
  const ub=base.map(v=>v+REF_BAND);
  const lb=base.map(v=>v-REF_BAND);
  const real=buildDomainSeries(dom);
  const labels=AGE_LIST.map(a=>a+'æœˆ');

  const W=720, H=260, x0=50, y0=10, w=W-70, h=190;
  const svg=createSVG(W,H);
  renderGrid(svg, x0,y0,w,h, 0,100,20);
  renderXAxis(svg, x0,y0,w,h, labels);

  const ubPts=toPoints(ub, x0,y0,w,h, 0,100);
  const basePts=toPoints(base, x0,y0,w,h, 0,100);
  const lbPts=toPoints(lb, x0,y0,w,h, 0,100);
  const realPts=toPoints(real, x0,y0,w,h, 0,100);

  drawPath(svg, linePath(ubPts), 'currentColor', 1, '6,6');
  drawPath(svg, linePath(basePts), 'currentColor', 2, '2,6');
  drawPath(svg, linePath(lbPts), 'currentColor', 1, '6,6');
  drawPath(svg, segmentedPath(realPts), 'currentColor', 2);
  drawPoints(svg, realPts, 3);

  container.appendChild(svg);
}
function renderSmallCharts(force=false){
  const wrap=document.getElementById('smallCharts');
  if(force) wrap.innerHTML='';
  if(!wrap.children.length){
    DOMAINS.forEach(dom=>{
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`<h2>${dom}</h2><div class="small-chart"></div>`;
      wrap.appendChild(card);
    });
  }
  const io=new IntersectionObserver((entries)=>{
    entries.forEach(en=>{
      if(en.isIntersecting){
        const title=en.target.querySelector('h2').textContent;
        const panel=en.target.querySelector('.small-chart');
        if(!panel.dataset.rendered){ renderSmallChart(title, panel); panel.dataset.rendered='1'; }
        io.unobserve(en.target);
      }
    });
  },{root:null, threshold:.2});
  wrap.querySelectorAll('.card').forEach(c=>io.observe(c));
}

/* ä»ªè¡¨æ¿ */
function mean(arr){ const v=arr.filter(x=>typeof x==='number'); if(!v.length) return null; return v.reduce((a,b)=>a+b,0)/v.length; }
function stddev(arr){ const v=arr.filter(x=>typeof x==='number'); if(v.length<2) return 0; const m=mean(v); return Math.sqrt(v.reduce((s,x)=>s+Math.pow(x-m,2),0)/(v.length-1)); }
function linreg(x,y){ const xs=[], ys=[]; for(let i=0;i<y.length;i++){ if(typeof y[i]==='number'){ xs.push(x[i]); ys.push(y[i]); } } if(xs.length<2) return 0; const n=xs.length, sx=xs.reduce((a,b)=>a+b,0), sy=ys.reduce((a,b)=>a+b,0); const sxx=xs.reduce((a,b)=>a+b*b,0), sxy=xs.reduce((a,b,i)=>a+b*ys[i],0); return (n*sxy - sx*sy)/(n*sxx - sx*sx); }
function renderStats(){
  const wrap=document.getElementById('statsTableWrap'); wrap.innerHTML='';
  const table=document.createElement('table'); table.className='table';
  const thead=`<thead><tr><th>ç»´åº¦</th><th>å‡å€¼(0â€“100)</th><th>æ ‡å‡†å·®</th><th>å¢é•¿é€Ÿç‡(æ¯6æœˆ)</th><th>çŠ¶æ€</th></tr></thead>`;
  let tbody='<tbody>';
  const sparks=document.getElementById('sparks'); sparks.innerHTML='';
  DOMAINS.forEach(dom=>{
    const ser = AGE_LIST.map(a=>avg10(indicatorScores[dom]?.[a]||[]));
    const m = mean(ser); const s = stddev(ser); const slope = linreg([0,1,2,3,4,5], ser.map(v=>v??NaN));
    const st = (m==null)?'â€”':(m>=75?'good':(m>=55?'warn':'bad'));
    const badge=`<span class="badge ${st}">${st==='good'?'è‰¯å¥½':(st==='warn'?'éœ€å…³æ³¨':'éœ€æå‡')}</span>`;
    tbody += `<tr><td>${dom}</td><td>${m==null?'â€”':m.toFixed(1)}</td><td>${s? s.toFixed(1):'0.0'}</td><td>${slope? slope.toFixed(2):'0.00'}</td><td>${badge}</td></tr>`;
    // sparkline
    const svg = createSVG(300,70);
    const x0=30,y0=10,w=250,h=40;
    renderGrid(svg,x0,y0,w,h,0,100,50);
    const pts=toPoints(ser, x0,y0,w,h,0,100);
    drawPath(svg, segmentedPath(pts), 'currentColor', 2);
    drawPoints(svg, pts, 2.5);
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<h2>${dom}</h2>`; card.appendChild(svg);
    sparks.appendChild(card);
  });
  tbody+='</tbody>';
  table.innerHTML=thead+tbody; wrap.appendChild(table);
}

/* å®¶åº­ç¯å¢ƒ */
function buildHomeTable(){
  const body=document.getElementById('homeRows'); body.innerHTML='';
  HOME_ITEMS.forEach((it,idx)=>{
    const tr=document.createElement('tr');
    const cur = homeScores[idx]??3;
    tr.innerHTML=`<td><strong>${it[0]}</strong></td>
      <td class="small">${it[1]}<br><span class="muted">${it[2]}</span></td>
      <td><select class="select" data-home="${idx}">${[1,2,3,4,5].map(v=>`<option value="${v}" ${cur===v?'selected':''}>${v}</option>`).join('')}</select></td>`;
    body.appendChild(tr);
  });
}
document.getElementById('homeClear').onclick=()=>{
  homeScores = Array(12).fill(3);
  buildHomeTable();
  document.getElementById('homeResult').innerHTML='';
  saveScores();
};
document.getElementById('homeSave').onclick=()=>{
  document.querySelectorAll('[data-home]').forEach(s=> homeScores[parseInt(s.dataset.home)] = parseInt(s.value) );
  saveScores(true);
};
document.getElementById('homeCalc').onclick=()=>{
  document.querySelectorAll('[data-home]').forEach(s=> homeScores[parseInt(s.dataset.home)] = parseInt(s.value) );
  const vals=[...homeScores];
  const avg=(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2);
  const level = avg>=4.5?'ä¼˜ç§€':(avg>=3.5?'è‰¯å¥½':(avg>=2.5?'åŸºæœ¬è¾¾æ ‡':'éœ€åŠ å¼º'));
  const sug = level==='ä¼˜ç§€'?'ç»´æŒå¹¶æ‹“å±•é«˜è´¨é‡äº’åŠ¨åœºæ™¯ã€‚':(level==='è‰¯å¥½'?'å·©å›ºç°æœ‰åšæ³•ï¼Œé’ˆå¯¹å¼±é¡¹è®¾ç«‹æ¯å‘¨å¾®ç›®æ ‡ã€‚':(level==='åŸºæœ¬è¾¾æ ‡'?'é‡ç‚¹åŠ å¼ºäº²å­é˜…è¯»ä¸è¯­è¨€äº’åŠ¨ã€‚':'ä¼˜å…ˆä¼˜åŒ–ä½œæ¯ã€å®‰å…¨ä¸å›åº”æ€§ä¸‰é¡¹åŸºç¡€ä¿éšœã€‚'));
  const list=HOME_ITEMS.map((it,i)=>`<li><strong>${it[0]}</strong>ï¼šå½“å‰è¯„åˆ† ${homeScores[i]}</li>`).join('');
  document.getElementById('homeResult').innerHTML=`<h2>ç»“æœ</h2><p>å¹³å‡åˆ†ï¼š<strong>${avg}</strong>ï¼ˆ${level}ï¼‰</p><ul>${list}</ul><p class="small muted">å»ºè®®ï¼š${sug}</p>`;
  saveScores();
};

/* å­˜å‚¨ */
function initScores(){
  const o={};
  DOMAINS.forEach(d=>{
    o[d]={};
    AGE_LIST.forEach(a=>{
      const n=(INDICATOR_TEXT[d]&&INDICATOR_TEXT[d][a])?INDICATOR_TEXT[d][a].length:0;
      o[d][a]=Array(n).fill(null);
    });
  });
  return o;
}
function loadScores(){
  try{ const raw=localStorage.getItem(STORE_KEY); if(!raw) return null; const obj=JSON.parse(raw); if(obj.homeScores) homeScores=obj.homeScores; return obj.indicatorScores; }catch(e){ return null; }
}
function saveScores(hint){
  const data={indicatorScores, homeScores};
  localStorage.setItem(STORE_KEY, JSON.stringify(data));
  if(hint){ const el=document.getElementById('saveHint'); if(el){ el.textContent='å·²ä¿å­˜'; setTimeout(()=>{el.textContent='';},1000); } }
  // åˆ·æ–° JSON é¢„è§ˆ
  const pre=document.getElementById('jsonPreview');
  if(pre) pre.textContent = JSON.stringify(data, null, 2);
}

/* å…±é¤å£ä»¤ï¼šWebAudio ç®€æ˜“èŠ‚å¥ */
(function(){
  const btn=document.getElementById('cmdBtn');
  if(!btn) return;
  btn.onclick=()=>{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    function beep(t0, dur=.15, freq=880){
      const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type='sine'; o.frequency.value=freq;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.2, t0+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
      o.start(t0); o.stop(t0+dur+0.02);
    }
    const t=ctx.currentTime+0.05;
    // â€œå¼ å˜´â€”å’¬ä¸€å£â€”çœŸæ£’ï¼â€ 3æ‹ï¼šé«˜-ä¸­-é«˜
    beep(t+0.00, 0.14, 980);
    beep(t+0.45, 0.16, 660);
    beep(t+0.90, 0.18, 980);
  };
})();

/* è¡¨æƒ…è´´çº¸ */
(function(){
  const box=document.getElementById('stickers'); const text=document.getElementById('stickerText');
  if(!box||!text) return;
  box.addEventListener('click', (e)=>{
    const t=e.target.closest('.sticker'); if(!t) return;
    box.querySelectorAll('.sticker').forEach(s=>s.classList.remove('active'));
    t.classList.add('active');
    const state=t.dataset.state;
    if(state==='happy') text.textContent='å½“å‰çŠ¶æ€ï¼šå¼€å¿ƒ â€”â€” ç»§ç»­ä¿æŒè½»æ¾äº’åŠ¨ä¸æ­£å‘åé¦ˆã€‚';
    else if(state==='resist') text.textContent='å½“å‰çŠ¶æ€ï¼šæŠ—æ‹’ â€”â€” æ”¾æ…¢èŠ‚å¥ï¼Œæä¾›é€‰æ‹©æƒä¸æƒ…ç»ªå®‰æŠšã€‚';
    else text.textContent='å½“å‰çŠ¶æ€ï¼šæ»¡è¶³ â€”â€” æš‚åœå–‚é£Ÿï¼Œé¼“åŠ±è‡ªä¸»è¡¨è¾¾â€œæˆ‘åƒé¥±äº†â€ã€‚';
  });
})();

/* æ¸²æŸ“å…¥å£ */
function renderAll(){
  // åˆå§‹åŒ–æŒ‡ç¤ºå™¨
  setDomain(curDomain); setAge(curAge);
  updateIndicatorsTable(); renderMonthlyChart(); buildHomeTable();
}
renderAll();
goHome();
</script>

<dialog id="authDlg" style="border:1px solid var(--line);border-radius:12px;padding:16px;max-width:360px">
  <h2 style="margin-top:0">ç™»å½• / æ³¨å†Œ</h2>
  <div style="display:grid;gap:8px">
    <input id="emailInp" class="input" placeholder="é‚®ç®±" type="email" autocomplete="username" />
    <input id="passInp" class="input" placeholder="å¯†ç ï¼ˆâ‰¥6ä½ï¼‰" type="password" autocomplete="current-password" />
    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="btn" id="doSignIn">ç™»å½•</button>
      <button class="btn" id="doSignUp">æ³¨å†Œ</button>
      <button class="btn" id="closeDlg" style="margin-left:auto">å…³é—­</button>
    </div>
    <p class="small muted">æç¤ºï¼šæ³¨å†ŒæˆåŠŸåä¼šè‡ªåŠ¨åˆ›å»ºäº‘ç«¯ç©ºé—´ï¼ˆè§’è‰²é»˜è®¤ä¸º <code>user</code>ï¼‰ã€‚</p>
  </div>
</dialog>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// === ç”¨ä½ çš„ Firebase æ§åˆ¶å°é…ç½®æ›¿æ¢ä¸‹é¢å¯¹è±¡ ===
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// UI refs
const authOpenBtn = document.getElementById('authOpenBtn');
const signOutBtn  = document.getElementById('signOutBtn');
const cloudSaveBtn= document.getElementById('cloudSaveBtn');
const cloudLoadBtn= document.getElementById('cloudLoadBtn');
const whoami      = document.getElementById('whoami');
const dlg   = document.getElementById('authDlg');
const email = document.getElementById('emailInp');
const pass  = document.getElementById('passInp');
const doSignIn = document.getElementById('doSignIn');
const doSignUp = document.getElementById('doSignUp');
const closeDlg = document.getElementById('closeDlg');

authOpenBtn.onclick = ()=> dlg.showModal();
closeDlg.onclick    = ()=> dlg.close();

doSignIn.onclick = async ()=>{
  try{
    await signInWithEmailAndPassword(auth, (email.value||'').trim(), pass.value);
    dlg.close();
  }catch(e){ alert('ç™»å½•å¤±è´¥ï¼š'+(e.message||e)); }
};

doSignUp.onclick = async ()=>{
  try{
    const res = await createUserWithEmailAndPassword(auth, (email.value||'').trim(), pass.value);
    await setDoc(doc(db,'users', res.user.uid), { email: res.user.email, role: 'user', createdAt: Date.now() }, { merge:true });
    await ensureDatasetDoc(res.user.uid);
    dlg.close();
  }catch(e){ alert('æ³¨å†Œå¤±è´¥ï¼š'+(e.message||e)); }
};

signOutBtn.onclick = ()=> signOut(auth);

onAuthStateChanged(auth, async (user)=>{
  if(user){
    whoami.textContent = 'å·²ç™»å½•ï¼š'+user.email;
    signOutBtn.style.display=''; cloudSaveBtn.style.display=''; cloudLoadBtn.style.display='';
    authOpenBtn.style.display='none';
  }else{
    whoami.textContent='';
    signOutBtn.style.display='none'; cloudSaveBtn.style.display='none'; cloudLoadBtn.style.display='none';
    authOpenBtn.style.display='';
  }
});

async function cloudSave(){
  const user = auth.currentUser;
  if(!user) return alert('è¯·å…ˆç™»å½•');
  const payload = { indicatorScores, homeScores, updatedAt: Date.now() };
  const ref = doc(db, 'users', user.uid, 'datasets', 'main');
  await setDoc(ref, payload, { merge:true });
  alert('å·²ä¿å­˜åˆ°äº‘ç«¯ âœ…');
}
async function cloudLoad(){
  const user = auth.currentUser;
  if(!user) return alert('è¯·å…ˆç™»å½•');
  const ref = doc(db, 'users', user.uid, 'datasets', 'main');
  const snap = await getDoc(ref);
  if(!snap.exists()) return alert('äº‘ç«¯æš‚æœªå‘ç°æ•°æ®');
  const data = snap.data();
  if(data.indicatorScores) indicatorScores = data.indicatorScores;
  if(data.homeScores) homeScores = data.homeScores;
  if(window.renderAll) renderAll();
  alert('å·²ä»äº‘ç«¯è¯»å– âœ…');
}
cloudSaveBtn.onclick = cloudSave;
cloudLoadBtn.onclick = cloudLoad;

async function ensureDatasetDoc(uid){
  const ref = doc(db,'users', uid, 'datasets', 'main');
  const snap = await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref, { indicatorScores: indicatorScores||{}, homeScores: homeScores||[], updatedAt: Date.now() });
  }
}
</script>

</body>
</html>
